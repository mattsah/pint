%{
  #include "tree.h"

  using namespace pint;
  using Value = std::shared_ptr<Node>;
%}


%token REAL
%token INTEGER
%token BOOLEAN
%token STRING
%token IDENTIFIER
%token COLON
%token SEMICOLON
%token SEPARATOR

%%

code
  : %empty {
    $$ = std::make_shared<ListNode>();
    std::cout << "empty code : make list" << std::endl;
  }
  | code code_line {
    std::cout << "code code_line : add to list" << std::endl;
    as(ListNode, $1)->list.push_back($2);
    $$ = $1;
  }
;

code_line
  : unit
  | uses
  | register {
    $$ = $1;
    std::cout << "code line : passtru" << std::endl;
  }
;

body
  : %empty {
    $$ = std::make_shared<ListNode>();
    std::cout << "empty body: make list" << std::endl;
  }
  | body body_line {
    std::cout << "body body_line : add to list" << std::endl;
    as(ListNode, $1)->list.push_back($2);
    $$ = $1;
    std::cout << "DONE: body body_line : add to list" << std::endl;
  }
;

body_line
  : "test" SEMICOLON {
    $$ = std::make_shared<Node>();
    std::cout << "test; in body_line : make node" << std::endl;
  }
;

identifier
  : IDENTIFIER {
    // identifier
    $$ = std::make_shared<IdentifierNode>($1);
    std::cout << "identifier : make node: " << $1 << std::endl;
  }
;

path_as
  : unit_path {
    $$ = std::make_shared<PathAsNode>(as(ListNode, $1));
  }
  | unit_path '.' identifier {
    $$ = std::make_shared<PathAsNode>(as(ListNode, $1), as(IdentifierNode, $3));
  }
  | path_as "as" identifier {
    as(PathAsNode, $1)->setAlias(as(IdentifierNode, $3));
    $$ = $1;
  }
  | unit_path '(' identifier_as_list ')' {
    $$ = std::make_shared<Node>();
  } 
;

identifier_as
  : identifier {
    $$ = std::make_shared<Node>();
  }
  | identifier "as" identifier {
    $$ = std::make_shared<Node>();
  }
;

identifier_as_list
  : identifier_as {
    $$ = std::make_shared<ListNode>($1);
  }
  | identifier_as_list ',' identifier_as {
    as(ListNode, $1)->list.push_back($3);
    $$ = $1;
  }
;

unit
  : "unit" unit_path SEMICOLON {
    $$ = std::make_shared<UnitNode>(as(ListNode, $2));
  }
;

unit_path
  : identifier {
    $$ = std::make_shared<ListNode>($1);
  }
  | unit_path SEPARATOR identifier {
    as(ListNode, $1)->list.push_back($3);
    $$ = $1;
  }
;

unit_path_list
  : unit_path {
    $$ = std::make_shared<ListNode>($1);
  }
  | unit_path ',' unit_path {
    as(ListNode, $1)->list.push_back($3);
    $$ = $1;
  }
;

uses
  : "uses" uses_list SEMICOLON {
    $$ = std::make_shared<UsesNode>(as(ListNode, $2));
  }
;

uses_list
  : path_as {
    $$ = std::make_shared<ListNode>($1);
  }
  | uses_list ',' path_as {
    as(ListNode, $1)->list.push_back($3);
    $$ = $1;
  }
;

register
  : "register" identifier COLON type_form_decl '=' body_line {
    $$ = std::make_shared<Node>();
    std::cout << "1. register identifier : type_form_decl = body_line : make node and return it" << std::endl;
  }
  | "register" identifier COLON type_func_decl '=' body_line {
    // register: function =
    $$ = std::make_shared<Node>();
    std::cout << "2. register identifier : type_func_decl = body_line : make node and return it" << std::endl;
  }
  | "register" identifier COLON type_func_decl "begin" body "end" {
    // register: function body
    $$ = std::make_shared<Node>();
    std::cout << "3. register identifier : type_func_decl begin body end : make node and return it" << std::endl;
  }
  | "register" identifier COLON type_tmpl_decl "begin" body "end" {
    $$ = std::make_shared<Node>();
    std::cout << "4. register identifier : type_tmpl_decl begin body end : make node and return it" << std::endl;
  }
;

size
  : %empty {
    $$ = std::make_shared<Node>();
  }
  | INTEGER {
    // size: INTEGER
    $$ = std::make_shared<Node>();
  }
;

length
  : %empty {
    $$ = std::make_shared<Node>();
  }
  | INTEGER {
    // length: INTEGER
    $$ = std::make_shared<Node>();
  }
;

return
  : void {
    // return: void
    std::cout << "void ret: make node and ret it" << std::endl;
    $$ = std::make_shared<Node>();
  }
  | type {
    // return: type
    std::cout << "type in ret : make node and ret it" << std::endl;
    $$ = std::make_shared<Node>();
  }
;

type
  : type_base {
    // type: type_base
    $$ = std::make_shared<Node>();
  }
  | identifier {
    // type: identifier
    $$ = std::make_shared<Node>();
  }
  | type '[' length ']' {
    // type: type_base|identifier[length]i
    $$ = $1;
  }
;

literal
  : REAL
  | INTEGER
  | BOOLEAN
  | STRING {
    $$ = std::make_shared<Node>();
  }
;

type_form_decl
  : type_form {
    $$ = std::make_shared<Node>();
  }
  | type_form '(' ')' {
    $$ = std::make_shared<Node>();
  }
  | type_form '(' unit_path_list ')' {
    $$ = std::make_shared<Node>();
  }
;

type_tmpl_decl
  : type_tmpl {
    $$ = std::make_shared<Node>();
  }
  | type_tmpl '(' ')' {
    $$ = std::make_shared<Node>();
  }
  | type_tmpl '(' unit_path_list ')' {
    $$ = std::make_shared<Node>();
  }
;

type_func_decl
  : type_func '(' arg_list ')' COLON return {
    std::cout << "type_func(arg_list):ret in type_func_decl :: make node and return it" << std::endl;
    // type_func_decl
    $$ = std::make_shared<Node>();
  }
;

type_cons_decl
  : type_cons '(' arg_list ')' COLON void {
    $$ = std::make_shared<Node>();
  }
;

identifier_list
  : identifier {
    $$ = std::make_shared<ListNode>($1);
    std::cout << "identifier: make list and return it" << std::endl;
  }
  | identifier_list ',' identifier {
    std::cout << "identifier_list ',' identifier: add to list and return it" << std::endl;
    as(ListNode, $1)->list.push_back($3);
    $$ = $1;
  }
;

arg
  : identifier_list {
    $$ = $1;
    std::cout << "identifier_list : pass thru " << std::endl;
  }
  | identifier_list COLON type {
    $$ = $1;
    std::cout << "identifier_list COLON type in arg : pass thru" << std::endl;
  }
;

arg_set
  : arg {
    // arg
    std::cout << "single arg in arg_set (make a list)" << std::endl;
    $$ = std::make_shared<ListNode>($1);
  }
  | arg_set SEMICOLON arg {
    // arg_set SEMICOLON arg
    std::cout << "arg_set SEMICOLON arg in arg_set: add to list and return it" << std::endl;
    as(ListNode, $3)->list.push_back($1);
    std::cout << "DONE: arg_set SEMICOLON arg in arg_set: add to list and return it" << std::endl;
    $$ = $3;
  }
;

arg_list
  : %empty {
    // arg_list: empty
    std::cout << "empty arg_list : make listy and return it" << std::endl;
    $$ = std::make_shared<ListNode>();
  }
  | arg_set {
    // arg_set
    $$ = $1;
    std::cout << "arg_set in arg_list: pass thru" << std::endl;
  }
;

void
  : "void" {
    // void
    $$ = std::make_shared<Node>();
  }
;

type_base
  : "integer" | "cardinal" | "real" | "char" | "string" | "boolean" {
    $$ = std::make_shared<Node>();
  }
  | type_base '(' size ')' {
    $$ = $1
  }
;

type_form
  : "label" | "type" | "record" {
    $$ = std::make_shared<Node>();
  }
;

type_tmpl
  : "interface" | "implementation" | "class" {
    $$ = std::make_shared<Node>();
  }
;

type_func
  : "function" {
    $$ = std::make_shared<Node>();
  }
;

type_cons
  : "constructor" {
    $$ = std::make_shared<Node>();
  }
;
